FROM python:3.10

# ë©”íƒ€ë°ì´í„°
LABEL app.main_file="app.py"
LABEL app.created="2025-06-06 01:54:22"
LABEL app.requirements_count="9"
LABEL app.problematic_packages="2"
LABEL maintainer="Streamlit Platform"
LABEL base.version="python3.10"
LABEL base.type="datascience"

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤ íŒ¨í‚¤ì§€ìš©)
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    gfortran \
    libopenblas-dev \
    liblapack-dev \
    libhdf5-dev \
    libhdf5-serial-dev \
    pkg-config \
    curl \
    wget \
    git \
    procps \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# pip ë° ë¹Œë“œ ë„êµ¬ ì—…ê·¸ë ˆì´ë“œ
RUN pip install --upgrade pip setuptools wheel cython

# í™˜ê²½ ì„¤ì •
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV PYTHONUNBUFFERED=1

# ê¸°ë³¸ ìˆ˜ì¹˜ ê³„ì‚° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¨¼ì € ì„¤ì¹˜ (ì•ˆì •ì ì¸ ë²„ì „)
RUN pip install --no-cache-dir \
    numpy==1.24.3 \
    pandas==2.0.3 \
    scipy==1.11.1

# Streamlit ì„¤ì¹˜
RUN pip install --no-cache-dir streamlit==1.28.1

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8501

# í—¬ìŠ¤ì²´í¬ ì„¤ì • (ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤ ì•±ì€ ì‹œì‘ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl --fail http://localhost:8501/_stcore/health || exit 1

# ì‹¤í–‰ ì‚¬ìš©ì ì„¤ì •
RUN useradd -m -u 1000 streamlit && \
    chown -R streamlit:streamlit /app

# ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["streamlit", "hello"]



# ì•±ë³„ ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .

# ì»´íŒŒì¼ì´ í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ì„ ë¨¼ì € ì„¤ì¹˜
RUN echo "ğŸ”§ ì»´íŒŒì¼ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œì‘..." && \
    pip install --no-cache-dir "numpy==1.21.0" && \    pip install --no-cache-dir "pandas==1.3.0" && \
    echo "âœ… ì»´íŒŒì¼ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

# ë‚˜ë¨¸ì§€ ì˜ì¡´ì„± ì„¤ì¹˜ (ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨)
RUN pip install --no-cache-dir -r requirements.txt || \
    (echo "âš ï¸ requirements.txt ì¼ê´„ ì„¤ì¹˜ ì‹¤íŒ¨, ê°œë³„ ì„¤ì¹˜ ì‹œë„..." && \
     while IFS= read -r requirement; do \
         if [ -n "$requirement" ] && [ "${requirement#\#}" = "$requirement" ]; then \
             echo "ğŸ“¦ Installing: $requirement"; \
             pip install --no-cache-dir "$requirement" || echo "âŒ Failed: $requirement"; \
         fi; \
     done < requirements.txt)

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY . .

# ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
RUN find . -name "*.pyc" -delete && \
    find . -name "__pycache__" -type d -exec rm -rf {} + || true

# ì‹¤í–‰ ì‚¬ìš©ìë¡œ ì „í™˜
USER streamlit

# ì‹¤í–‰ ëª…ë ¹ì–´
ENTRYPOINT ["streamlit", "run", "app.py", \
    "--server.port=8501", \
    "--server.address=0.0.0.0", \
    "--server.headless=true", \
    "--server.enableCORS=false", \
    "--server.enableXsrfProtection=false"]